<script type="text/javascript">
    RED.nodes.registerType('meo-event', {
        category: 'MEO',
        color: '#d8bfd8',
        defaults: {
            name: { value: "" },
            server: { value: "", type: "meo-config", required: true },
            device_id: { value: "" },
            event_name: { value: "" }
        },
        inputs: 0,
        outputs: 1,
        icon: "bridge.svg",
        label: function() {
            return this.name || "Meo Event";
        },
        oneditprepare: function() {
            var select = $("#node-input-device-id");
            var currentVal = this.device_id;
            
            // fetch devices
            $.getJSON("http://meo-open-service.local:7000/api/devices", function(data) {
                // Clear "Loading..."
                select.empty();
                
                // Add "Any Device" option
                $("<option/>").val("+").text("Any Device (Wildcard)").appendTo(select);

                if(data && Array.isArray(data)) {
                    data.forEach(function(dev) {
                        $("<option/>")
                            .val(dev.id)
                            .text(dev.label + " (" + dev.id + ")")
                            .appendTo(select);
                    });
                }
                // Restore saved value
                if (currentVal) { select.val(currentVal); }
            }).fail(function() {
                // Fallback if API fails
                select.empty();
                $("<option/>").val(currentVal).text(currentVal || "Service Unreachable - Enter ID manually").appendTo(select);
                console.log("Failed to connect to MEO Service API.");
            });
        }
    });
</script>

<script type="text/html" data-template-name="meo-event">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-globe"></i> Config</label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
        <label for="node-input-device-id"><i class="fa fa-microchip"></i> Device</label>
        <select id="node-input-device-id" style="width:70%">
            <option value="" disabled selected>Loading devices...</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-event_name"><i class="fa fa-bell"></i> Event</label>
        <input type="text" id="node-input-event_name" placeholder="e.g. sensor_update (optional)">
    </div>
</script>